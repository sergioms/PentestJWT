import unittest
import TestJWT


class TestTestJWT(unittest.TestCase):

    def setUp(self):
        self.token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.\
eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.\
SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c"
        print(self.token)
        _, _, self.sig = self.token.split(".", 3)
        print(self.sig)
        self.secret = "your-256-bit-secret"
        self.tjwt: TestJWT = TestJWT.TestJWT.deserialize(self.token)

    def test_deserialize_no_json(self):
        no_json_token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.\
InN1YiI6ICIxMjM0NTY3ODkwIiwibmFtZSI6ICJKb2huIERvZSIsImlhdCI6IDE1MTYyMzkwMjI.\
SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c"
        no_json_tjwt: TestJWT = TestJWT.TestJWT.deserialize(no_json_token)
        no_json_tjwt.show_token()
        self.assertFalse(no_json_tjwt.is_json)
        self.assertEqual("HS256", no_json_tjwt.get_algorithm())
        self.assertEqual("JWT", no_json_tjwt.header['typ'])
        self.assertEqual("\"sub\": \"1234567890\",\"name\": \"John Doe\",\"iat\": 1516239022", no_json_tjwt.get_payload())
        self.assertTrue(self.tjwt.verify_signature(self.secret, self.sig))

    def test_verify(self):
        self.assertTrue(self.tjwt.is_json)
        self.assertEqual("HS256", self.tjwt.get_algorithm())
        self.assertEqual("JWT", self.tjwt.header['typ'])
        self.assertEqual("1234567890", self.tjwt.get_payload()['sub'])
        self.assertEqual(1516239022, self.tjwt.get_payload()['iat'])
        self.assertEqual("John Doe", self.tjwt.get_payload()['name'])
        self.assertTrue(self.tjwt.verify_signature(self.secret, self.sig))

    def test_verification_failed_wrong_secret(self):
        self.assertTrue(self.tjwt.is_json)
        self.assertEqual("HS256", self.tjwt.get_algorithm())
        self.assertEqual("JWT", self.tjwt.header['typ'])
        self.assertEqual("1234567890", self.tjwt.get_payload()['sub'])
        self.assertEqual(1516239022, self.tjwt.get_payload()['iat'])
        self.assertEqual("John Doe", self.tjwt.get_payload()['name'])
        self.assertFalse(self.tjwt.verify_signature("Your-256-bit-secret", self.sig))


if __name__ == '__main__':
    unittest.main()
